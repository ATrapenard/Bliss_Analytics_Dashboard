{% extends "_layout.html" %}

{% block title %}Stock Transfer{% endblock %}

{% block content %}
<style>
    .container {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 40px;
    }

    table {
        table-layout: fixed;
    }

    th:nth-child(1) {
        width: 30%;
    }

    /* Location */
    th:nth-child(2) {
        width: 45%;
    }

    /* Product */
    th:nth-child(3) {
        width: 25%;
    }

    /* Quantity */

    .form-container {
        align-self: start;
    }

    @media screen and (max-width: 1100px) {
        .container {
            grid-template-columns: 1fr;
        }

        .form-container {
            order: -1;
        }
    }
</style>

<h1>Stock Transfer</h1>
<p>Move finished product stock between locations.</p>

{% with messages = get_flashed_messages(with_categories=true) %}
{% if messages %}
{% for category, message in messages %}
<div class="flash-{{ category }}">{{ message }}</div>
{% endfor %}
{% endif %}
{% endwith %}

<div class="container">
    <div class="list-container content-card">
        <div class="search-container">
            <input type="text" id="searchStock" placeholder="Search by Location or Product...">
        </div>
        <h2>Current Finished Stock</h2>
        <table>
            <thead>
                <tr>
                    <th>Location</th>
                    <th>Product (SKU)</th>
                    <th>Quantity On Hand</th>
                </tr>
            </thead>
            <tbody>
                {% for item in current_stock %}
                <tr>
                    <td>{{ item.location_name }}</td>
                    <td>{{ item.product_name }} ({{ item.sku }})</td>
                    <td>{{ item.quantity }}</td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="3" style="text-align: center;">No finished stock levels set.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="form-container content-card">
        <h2 class="collapsible-toggle">New Transfer</h2>
        <div class="form-content">
            <form method="POST" action="{{ url_for('ops.stock_transfer') }}">
                <div>
                    <label for="product_id">Product to Transfer</label>
                    <select id="product_id" name="product_id" required>
                        <option value="" disabled selected>-- Choose a product --</option>
                        {% for prod in products %}
                        <option value="{{ prod.id }}">{{ prod.product_name }} ({{ prod.sku }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="from_location_id">From Location</label>
                    <select id="from_location_id" name="from_location_id" required>
                        <option value="" disabled selected>-- Choose source --</option>
                        {% for loc in locations %}
                        <option value="{{ loc.id }}">{{ loc.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="to_location_id">To Location</label>
                    <select id="to_location_id" name="to_location_id" required>
                        <option value="" disabled selected>-- Choose destination --</option>
                        {% for loc in locations %}
                        <option value="{{ loc.id }}">{{ loc.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="quantity">Quantity</label>
                    <input type="number" id="quantity" name="quantity" min="1" required placeholder="e.g., 50">
                </div>
                <button type="submit" class="submit-btn">Execute Transfer</button>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Search bar logic
        const searchInput = document.getElementById('searchStock');
        const tableBody = document.querySelector('.list-container tbody');
        const allRows = tableBody.querySelectorAll('tr');

        searchInput.addEventListener('input', function (e) {
            const searchTerm = e.target.value.toLowerCase();
            allRows.forEach(row => {
                const locationName = row.cells[0].textContent.toLowerCase();
                const productName = row.cells[1].textContent.toLowerCase();
                if (locationName.includes(searchTerm) || productName.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });
</script>
{% endblock %}